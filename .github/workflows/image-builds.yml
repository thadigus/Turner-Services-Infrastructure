name: Run Packer Builds and Devcontainer

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC â†’ Sunday 10 PM ET

jobs:
  setup-container-image:
    name: Build DevContainer Image
    runs-on: self-hosted
    outputs:
      image: ghcr.io/thadigus/turner-services-infrastructure:devcontainer
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          submodules: recursive
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push devcontainer image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: images/iac-runner/Dockerfile
          push: true
          tags: ghcr.io/thadigus/turner-services-infrastructure:devcontainer

  download-isos:
    name: Download ISOs
    runs-on: self-hosted
    needs: setup-container-image
    container:
      image: ghcr.io/thadigus/turner-services-infrastructure:devcontainer
      options: --user root
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          submodules: recursive
      - name: Run download script
        run: ansible-playbook images/download-isos.yml

  ubuntu-packer-build:
    name: Ubuntu Packer Build
    runs-on: self-hosted
    needs: download-isos
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          submodules: recursive
      - name: Run Ubuntu Packer script
        run: |
          docker run --rm -d \
          --name build-runner \
          --network host \
          --user root \
          -v "$PWD":/workspace \
          -w /workspace \
          ghcr.io/thadigus/turner-services-infrastructure:devcontainer \
          sleep infinity

          docker exec build-runner git config --global --add safe.directory /workspace
          docker exec build-runner bash images/build-scripts/ubuntu-packer-build-rack.sh
          docker stop build-runner

  rhel-packer-build:
    name: RHEL Packer Build
    runs-on: self-hosted
    needs: download-isos
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          submodules: recursive
      - name: Run RHEL Packer script
        run: |
          docker run --rm -d \
          --name build-runner \
          --network host \
          --user root \
          -v "$PWD":/workspace \
          -w /workspace \
          ghcr.io/thadigus/turner-services-infrastructure:devcontainer \
          sleep infinity

          docker exec build-runner git config --global --add safe.directory /workspace
          docker exec build-runner bash images/build-scripts/rhel-packer-build-rack.sh
          docker stop build-runner

  windows-packer-build:
    name: Windows Packer Build
    runs-on: self-hosted
    needs: download-isos
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          submodules: recursive
      - name: Run Windows Packer script
        run: 
          docker run --rm -d \
          --name build-runner \
          --network host \
          --user root \
          -v "$PWD":/workspace \
          -w /workspace \
          ghcr.io/thadigus/turner-services-infrastructure:devcontainer \
          sleep infinity

          docker exec build-runner git config --global --add safe.directory /workspace
          docker exec build-runner bash images/build-scripts/windows-packer-build-rack.sh
          docker stop build-runner

  kali-packer-build:
    name: Kali Packer Build
    runs-on: self-hosted
    needs: download-isos
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          submodules: recursive
      - name: Run Kali Packer script
        run: 
          docker run --rm -d \
          --name build-runner \
          --network host \
          --user root \
          -v "$PWD":/workspace \
          -w /workspace \
          ghcr.io/thadigus/turner-services-infrastructure:devcontainer \
          sleep infinity

          docker exec build-runner git config --global --add safe.directory /workspace
          docker exec build-runner bash images/build-scripts/kali-packer-build-rack.sh
          docker stop build-runner
